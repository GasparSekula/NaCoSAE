"""
This module defines functions for saving pipeline history artifacts, like
LLM generation history or images generated by T2I.
"""

import dataclasses
import os
from typing import BinaryIO, Iterable, Sequence, TextIO

from PIL import Image

import pipeline
import scoring


def _write_iterable_to_stream(
    output_stream: TextIO, lines: Iterable[str]
) -> None:
    """Writes contents of an iterable to a text stream, one item per line."""
    output_stream.write("\n".join(lines))


def save_llm_history(
    history: Iterable[str], save_directory: str, filename: str
) -> None:
    """Saves the llm history to a file."""
    os.makedirs(save_directory, exist_ok=True)
    save_path = os.path.join(save_directory, filename)

    with open(save_path, "w") as save_file:
        _write_iterable_to_stream(save_file, history)


def _write_image_to_stream(output_stream: BinaryIO, image: Image.Image) -> None:
    """Writes an image to a stream."""
    image.save(output_stream, format="jpeg")


def save_images_from_iteration(
    images: Sequence[Image.Image], save_directory: str, iter_number: int
) -> None:
    """Saves images from a single pipeline iteration."""
    save_path = os.path.join(save_directory, f"iteration_{iter_number}")
    os.makedirs(save_path, exist_ok=True)
    for image_number, image in enumerate(images, 1):
        filename = f"image_{image_number}.jpeg"
        with open(os.path.join(save_path, filename), "wb") as save_file:
            _write_image_to_stream(save_file, image)


def save_pipeline_parameters(
    save_directory: str,
    run_id: str,
    load_config: pipeline.LoadConfig,
    image_generation_config: pipeline.ImageGenerationConfig,
    concept_history_config: pipeline.ConceptHistoryConfig,
    history_managing_config: pipeline.HistoryManagingConfig,
    neuron_id: int,
    metric: scoring.Metric,
    model_layer_activations_path: str,
):
    os.makedirs(save_directory, exist_ok=True)
    params = {
        "run_id": run_id,
        "load_config": dataclasses.asdict(load_config),
        "image_generation_config": dataclasses.asdict(image_generation_config),
        "concept_history_config": dataclasses.asdict(concept_history_config),
        "history_managing_config": dataclasses.asdict(history_managing_config),
        "neuron_id": neuron_id,
        "model_layer_activations_path": model_layer_activations_path,
        "metric": getattr(metric, "name", str(metric)),
    }
    params_path = os.path.join(save_directory, "params.txt")
    with open(params_path, "w") as f:
        for key, val in params.items():
            f.write(f"{key}: {val}\n")
